之前一直没有去仔细思考这块，处理方法也比较简单粗暴，扛不住了就加机器，绝大多数都交给了外部因子（主要是负载）去处理。

最近在公众号以及一些技术博客上阅读了一些文章，觉得人家的考虑还是有一些道理的，至少物尽其用老板开心，做得也有成就感。

主要参考[微信公众号的一篇文章](https://mp.weixin.qq.com/s/ad0gimaj6NlY2VPIEX65sA)，其他技术博客也有阅读，不过对这块知识总结大多零零散散，也不是说不好，就是语言组织上有点乱，大多思考到点，没顾及到面，这也是大多数开发写技术文章的通病，包括我自己。

大概有4种：窗口，滑动窗口，漏桶，令牌桶。

实现如下：

| 形式     | 实现细节                                                     | 适用场景                                                   | 不适用场景         |
| -------- | ------------------------------------------------------------ | ---------------------------------------------------------- | ------------------ |
| 窗口     | 预设一个速率，定期更新总接受量，总量=速率*更新周期。期间内总量没了，就执行策略，最大可能出现接近一个窗口期的执行策略时间。一个比较粗糙的实现，可用来应急。 | 应急                                                       | 非应急都不建议使用 |
| 滑动窗口 | 本质跟窗口一样。将窗口细分成若干个小窗口，计算的时候统计前N个窗口的量之和，与预计N个窗口时间段可接受总量比较，超出了就执行策略，不过执行策略的时间就这个小窗口时间段。可以稍微匀称化数据，提高可用性。 | 万金油v1，基本所有场景都适用                               |                    |
| 漏桶     | 可以理解为流量往漏斗里倒，拆分分两块看。第一块，嘴部速率恒定，可以用类窗口定期更新总接受量。第二块，斗部能容忍上限，嘴部不够用了就往斗部加水位，斗部溢出之前，定时循环判断嘴部是否可入，可入的话嘴部总量+1，斗部水位-1；溢出了则执行策略。 | 万金油v2，基本所有场景都适用。其实就是v1一个比较优雅的实现 |                    |
| 令牌桶   | 预先生成一批令牌，每个请求来了就取走一个，没有了就执行策略。因为令牌数量基本已经评估到瓶颈了，所以这种利用率非常高，但还是没法友好处理令牌耗空的情况。看起来高端，本质还是窗口，一种逆向窗口。 | 流量相对稳定，不大会出现剧增                               | 大起大落的流量结构 |

限流最好搭配熔断/降级等其他理念一起用，这样组合起来效果会更好。毕竟表格中提到的”执行策略“只是一句空话，需要具体的实现。

